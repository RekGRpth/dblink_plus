<!DOCTYPE HTML PUBLIC "-//W3C//DTD html 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>pgsql_fdw</title>
<link rel="home" title="pgsql_fdw" href="index.html">
<link rel="stylesheet" type="text/css" href="style.css">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>

<body>
<h1 id="pgsql_fdw">pgsql_fdw</h1>
<div class="navigation">
  <a href="../index.html">Top</a> &gt;
  <a href="pgsql_fdw-ja.html">pgsql_fdw</a>
<div>
<hr>

<div class="index">
<ol>
<li><a href="#name">名前</a></li>
<li><a href="#description">概要</a></li>
<li><a href="#install">導入方法</a>
<ol>
  <li><a href="#requirement">動作環境</a></li>
  <li><a href="#build">ビルド</a></li>
  <li><a href="#create-extension">エクステンションの作成</a></li>
  <li><a href="#uninstall">アンインストール</a></li>
</ol>
</li>
<li><a href="#usage">使い方</a></li>
<ol>
  <li><a href="#create-server">外部サーバの作成</a></li>
  <li><a href="#create-user-mapping">ユーザマッピングの作成</a></li>
  <li><a href="#create-foreign-table">外部テーブルの作成</a></li>
  <li><a href="#execute-query">検索の実行</a></li>
  <li><a href="#alter-options">オプションの変更</a></li>
  <li><a href="#connections">接続管理</a></li>
</ol>
<li><a href="#valid-options">有効なオプション</a></li>
<li><a href="#restrictions">使用上の注意と制約</a></li>
<li><a href="#details">詳細情報</a></li>
<ol>
  <li><a href="#connection-option">内部で設定する接続オプション</a></li>
  <li><a href="#functions">バリデータ関数とハンドラ関数</a></li>
</ol>
<li><a href="#seealso">関連項目</a></li>
</ol>
</div>

<h2 id="name">名前</h2>
<p>pgsql_fdw -- 外部のPostgreSQLサーバに対して検索を実行するための外部データラッパです。</p>
<h2 id="description">概要</h2>
<p>pgsql_fdwを用いると、外部のPostgreSQLサーバにあるテーブルに対応する外部テーブルを作成できます。また、、その外部テーブルを用いた通常のSELECT文を実行することで、通常のテーブルと同様に外部データを扱うことができます。</p>
<p>pgsql_fdwは、サーバ間でのデータ転送量を削減するために、外部のPostgreSQLに発行するクエリを最適化します。</p>
<ul>
<li>クエリに必要のない列をSELECT句から省略します。</li>
<li>一部のWHERE句条件を外部サーバ側でも評価します。</li>
</ul>
<p>PostgreSQL 9.1では外部テーブルは読み取り専用のため、pgsql_fdwで定義した外部テーブルに対する更新(INSERT/UPDATE/DELETE)はエラーとなり実行できません。</p>

<h2 id="install">導入方法</h2>
<p>pgsql_fdwのインストール方法について説明します。</p>
<!--
各インストールパッケージは<a href="https://sourceforge.net/projects/interdbconnect/files/pgsql_fdw">こちら</a>からダウンロードして下さい</p>
-->

<h3 id="requirement">動作環境</h3>
<dl>
<dt>PostgreSQL</dt><dd>バージョン 9.1</dd>
</dl>

<h3 id="build">ビルド</h3>
<p>pgsql_fdwをソースコードからビルドするには、PostgreSQL 9.1 のソースツリーか、インストール済みのpgxsが必要です。以下の例のx.y.zは、ダウンロードしたバージョンに読み替えて下さい。</p>

<h4 id="build-with-source">ソースツリーを用いたビルド</h4>
<p>PostgreSQLのソースツリーを使用する場合は、PostgreSQL本体のconfigureおよびビルドを済ませてから、contrib配下にpgsql_fdwのソースを展開し、makeを実施します。</p>
<pre>
$ cd postgresql-9.1.x
$ ./configure
$ make
$ cd contrib
$ tar zxvf pgsql_fdw-x.y.z.tar.gz
$ cd pgsql_fdw-x.y.z
$ make
$ sudo make install 
</pre>

<h4 id="build-with-pgxs">pgxsを用いたビルド</h4>
<p>pgxsを用いる場合は、USE_PGXS変数を設定してからビルドおよびインストールを実施します。</p>
<pre>
$ tar xzvf pgsql_fdw-x.y.z.tar.gz
$ cd pgsql_fdw
$ make USE_PGXS=1
$ sudo make USE_PGXS=1 install
</pre>

<h3 id="create-extension">エクステンションの作成</h3>
<p>pgsql_fdwはPostgreSQL 9.1で導入されたエクステンション形式に対応しているため、psqlなどでCREATE EXTENSIONコマンドを実行することで、関数などの構成要素とともに自動的に外部データラッパが作成されます。従来のcontribモジュールのように手動でSQLスクリプトを実行する必要はありません。なお、この作業にはスーパーユーザ権限が必要です。
<pre>
$ psql
postgres=# CREATE EXTENSION pgsql_fdw;
CREATE EXTENSION
postgres=# \dew
                 List of foreign-data wrappers
   Name    |  Owner   |      Handler      |      Validator
-----------+----------+-------------------+---------------------
 pgsql_fdw | postgres | pgsql_fdw_handler | pgsql_fdw_validator
(1 row)

postgres=#
</pre>
<p>

<h3 id="uninstall">アンインストール</h3>
<p>pgsql_fdwをアンインストールするには、DROP EXTENSION文を実行します。pgsql_fdwに関連するオブジェクトが存在する場合は、先にそれらを削除しておくか、CASCADEオプションが必要です。</p>
<p>以下の例では一つの外部サーバとユーザマッピング、四つの外部テーブルをまとめて削除しています。</p>
<pre>
postgres=# drop EXTENSION pgsql_fdw CASCADE;
NOTICE:  drop cascades to 6 other objects
DETAIL:  drop cascades to server remote_db
drop cascades to user mapping for public
drop cascades to foreign table remote_accounts
drop cascades to foreign table remote_branches
drop cascades to foreign table remote_tellers
drop cascades to foreign table remote_history
DROP EXTENSION
postgres=#
</pre>

<h2 id="usage">使い方</h2>
<p>pgsql_fdwを用いて外部のPostgreSQLサーバにあるテーブルを検索する手順について説明します。なお、接続情報はサンプルですので、実際の環境に合わせて適宜読み替えてください。</p>

<h3 id="create-server">外部サーバの作成</h3>

<p>スーパーユーザ権限のあるユーザでCREATE SERVERコマンドを実行して、検索対象のデータベースに対応する外部サーバを作成します。外部サーバのオプションとして、ホスト名やポート番号、データベース名を指定します。</p>
<pre>
postgres=# CREATE SERVER remote_db FOREIGN DATA WRAPPER pgsql_fdw
postgres-# OPTIONS (host 'hostname', port '5432', dbname 'remote');
CREATE SERVER
postgres=#
</pre>

<h3 id="create-user-mapping">ユーザマッピングの作成</h3>

<p>スーパーユーザ権限のあるユーザでCREATE USER MAPPINGコマンドを実行して、ローカルユーザとリモートユーザをひもづけるユーザマッピングを作成します。ユーザマッピングのオプションとして、リモートユーザのユーザ名やパスワードを指定します。</p>
<pre>
postgres=# CREATE USER MAPPING FOR postgres SERVER remote_db
postgres-# OPTIONS (user 'postgres', password 'secret');
CREATE USER MAPPING
postgres=#
</pre>
<p>任意のローカルユーザが外部テーブルを検索しても良いケースでは、ローカルユーザ名の変わりにpublicを指定することで、ユーザマッピングを持たないローカルユーザ用のマッピングを作成することもできます。</p>
<pre>
postgres=# CREATE USER MAPPING FOR public SERVER remote_db
postgres-# OPTIONS (user 'app_user', password 'secret');
CREATE USER MAPPING
postgres=#
</pre>

<h3 id="create-foreign-table">外部テーブルの作成</h3>

<p>スーパーユーザ権限のあるユーザでCREATE FOREIGN TABLEコマンドを実行して、検索対象のリモートテーブルに対応する外部テーブルを作成します。基本的な構文はCREATE TABLE文と同じですが、列リストの後に外部サーバを指定する必要があります。また、外部テーブルのオプションとして、スキーマ名とテーブル名を指定できます。以下の例では、pgbenchで使用するpgbench_accountsを検索するためのテーブルを定義しています。</p>
<pre>
postgres=# CREATE FOREIGN TABLE remote_accounts (
postgres(# aid integer,
postgres(# bid integer,
postgres(# abalance integer,
postgres(# filler char(84))
postgres(# SERVER remote_db
postgres(# OPTIONS (nspname 'public', relname 'pgbench_accounts');
CREATE FOREIGN TABLE
postgres=#
</pre>

<h3 id="execute-query">検索の実行</h3>
<p>外部テーブルが作成できたら、外部テーブルを使った通常のSELECT文を実行するだけで外部テーブルからデータを取得できます。実行するSELECTに制限はありませんが、外部テーブルに対する更新はできません。<p>
<pre>
postgres=# SELECT aid, bid, abalance FROM remote_accounts WHERE aid = 1;
 aid | bid | abalance
-----+-----+----------
   1 |   1 |        0
(1 row)

postgres=#
</pre>
<p>外部テーブルを作成したユーザ以外にも検索を許可したい場合は、通常のテーブルと同様にGRANT文でアクセス権限を付与します。</p>

<p>EXPLAIN コマンドを実行することで、実際に外部サーバに発行されているクエリを知ることができます。以下の例では、remote_accouns 外部テーブルを経由して pgbench_accounts テーブルにアクセスしていることが分かります。</p>
<pre>
postgres=# EXPLAIN SELECT aid, bid, abalance FROM remote_accounts WHERE aid = 1;
                                                                QUERY PLAN
------------------------------------------------------------------------------------------------------------------------------------------
 Foreign Scan on remote_accounts  (cost=100.00..108.30 rows=1 width=12)
   Filter: (aid = 1)
   Remote SQL: DECLARE pgsql_fdw_cursor_2 SCROLL CURSOR FOR SELECT aid, bid, abalance, NULL FROM public.pgbench_accounts WHERE (aid = 1)
(3 rows)
</pre>

<h3 id="alter-options">オプションの変更</h3>

<p>リモートユーザのパスワードなどの接続情報が変更された場合は、該当するオプションを定義したオブジェクトに対してALTER文を実行して、オプションの値を設定します。以下の例ではリモートユーザのパスワードを変更しています。CREATE文と異なり、既存オプションの変更にはSET指定が必要になるので注意してください。</p>
<pre>
postgres=# ALTER USER MAPPING FOR postgres SERVER remote_db
postgres-# OPTIONS (SET password 'more secret');
ALTER USER MAPPING
postgres=#
</pre>

<h3 id="connections">接続管理</h3>
<p>pgsql_fdwは、ある外部サーバ上の外部テーブルを最初に検索するときに接続を確立します。いったん確立された接続は、ローカルのセッションが続いている間はできる限り再利用されます。また、一つのクエリ中で同一外部サーバ上の複数の外部テーブルを使用していた場合も、接続を再利用します。このため、ある外部サーバへの接続は、ローカルユーザを切り替えない限り一つだけです。現在接続している外部サーバは、pgsql_fdw_connectionsビューで確認できます。
</p>
<pre>
postgres=# select * from pgsql_fdw_connections;
 srvid |    srvname     | usesysid | usename
-------+----------------+----------+----------
 16530 | remote_pgbench |       10 | postgres
(1 row)
</pre>
<p>任意のタイミングで接続を切断したい場合は、接続先の外部サーバのOIDとローカルユーザのOIDを指定して pgsql_fdw_disconnect() を実行してください。pgsql_fdw_connectionsビューは外部サーバとローカルユーザのOIDを返すので、下記のクエリを実行すると全ての接続を切断できます。</p>
<pre>
postgres=# SELECT pgsql_fdw_disconnect(srvid, usesysid) FROM pgsql_fdw_connections;
 pgsql_fdw_disconnect
----------------------
 OK
 OK
(2 rows)
</pre>
<p>なお、ローカルのトランザクションがアボートすると、pgsql_fdwは全ての外部サーバへの接続を切断します。これは、エラーなどによる接続リークを防ぐための対処です。その後、同じ外部サーバ上の外部テーブルを検索すると、再び自動的に接続が確立されます。</p>

<h2 id="valid-options">有効なオプション</h2>
<p>pgsql_fdwでは、リモートデータベースに対して検索を実行するのに必要な情報を、関連するオブジェクトの FDW オプションから取得します。</p>
<h3>接続オプション</h3>
外部サーバへの接続情報として、下記のものを除く全ての libpq オプションが指定可能です。user と password のみユーザマッピングに指定し、それ以外は外部サーバの FDW オプションに指定してください。
<ul>
<li>client_encoding</li>
<li>fallback_application_name</li>
<li>replication</li>
</ul>
</p>

<p>
libpq のオプションについては、「<a href="http://www.postgresql.jp/document/9.1/html/libpq-connect.html">データベース接続制御関数</a>」を参照してください。なお、接続オプションを省略した場合、ローカルのPostgreSQLサーバを起動したユーザの環境設定に従いますのでご注意ください。また、無効なオプションを指定した場合はオプション設定時にエラーが発生しますが、必須項目が省略されていたり設定した値が誤っていた場合は、検索実行時にエラーが発生するので注意してください。</p>

<h3>オブジェクト名オプション</h3>
<p>外部テーブルの FDW オプションとして nspname や relname オプションを設定すると、外部テーブルのオブジェクト名(それぞれスキーマ名とテーブル名)を指定できます。省略時にはローカルの外部テーブルと同じ名称が使われます。</p>

<h3>カーソルオプション</h3>
<p>fetch_count オプションを指定することで、pgsql_fdw が内部的に使用するカーソルで一回にフェッチする行数を指定できます。デフォルトは10,000行です。外部テーブルと外部サーバのどちらにも指定できますが、両方指定した場合は外部テーブルの設定が使われます。</p>

<h2 id="restrictions">使用上の注意と制約</h2>
<p>pgsql_fdwを使用する際には、以下の使用上の注意と制約があります。</p>

<dl>
<dt>外部テーブルは読み取り専用</dt>
<dd>PostgreSQLの仕様で外部テーブルは読み取り専用です。このため、更新系のDMLはエラーとなります。また、管理用のSQLコマンド(VACUUMやANALYZE)は外部テーブルを処理対象に含めません。これらのコマンドをリモート側のテーブルに対して実行したい場合は、psqlなどでリモートデータベースに直接接続してから実行してください。</dd>

<dt>接続とトランザクションの管理</dt>
<dd>pgsql_fdwでは、一つのクエリに複数の外部テーブルが含まれていた場合、それらが同じ外部サーバで定義されていればリモートデータベースへの接続を共有します。ただし、このときのトランザクション分離レベルはデフォルトのREAD COMMITTEDであるためため、リモートクエを実行するタイミングによっては読み取り結果に一貫性がない場合があります。</dd>
</dl>

<h2 id="details">詳細情報</h2>
<p>より高度な利用方法や、内部構成について説明します。</p>

<h3 id="connection-option">内部で設定する接続オプション</h3>
<p>pgsql_fdwでは、リモートデータベースに接続する際にclient_encodingとしてローカルのデータベースエンコーディングを使用します。これにより、コンバージョンが定義されていれば、エンコーディングの異なるデータベースからでもデータを取得することができます。また、内部でfallback_application_nameを「pgsql_fdw」に設定します。これにより、リモートデータベースのpg_stat_activityやサーバログで接続元がpgsql_fdwであることを確認できます。</p>

<h3 id="functions">バリデータ関数とハンドラ関数</h3>
<p>pgsql_fdwでは、バリデータ関数として pgsql_fdw_validatorを、ハンドラ関数としてpgsql_fdw_handler関数をそれぞれ定義します。これらはCREATE EXTENSION文で自動的に作成されます。</p>

<h2 id="seealso">関連項目</h2>
<h3 id="postgresql_document">PostgreSQLドキュメント</h3>
<a href="http://www.postgresql.jp/document/9.1/html/ddl-foreign-data.html">外部データ</a>,
<a href="http://www.postgresql.jp/document/9.1/html/sql-createforeigndatawrapper.html">CREATE FOREIGN DATA WRAPPER</a>,
<a href="http://www.postgresql.jp/document/9.1/html/sql-createserver.html">CREATE SERVER</a>,
<a href="http://www.postgresql.jp/document/9.1/html/sql-createusermapping.html">CREATE USER MAPPING</a>,
<a href="http://www.postgresql.jp/document/9.1/html/sql-createforeigntable.html">CREATE FOREIGN TABLE</a>,
<a href="http://www.postgresql.jp/document/9.1/html/libpq-connect.html">データベース接続制御関数</a>,
<hr>
<div class="navigation">
  <a href="../index.html">Top</a> &gt;
  <a href="pgsql_fdw-ja.html">pgsql_fdw</a>
<div>
<p class="footer">Copyright (c) 2011, NIPPON TELEGRAPH AND TELEPHONE CORPORATION</p>

<!--
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="pg_statsinfo-ja_files/ga.js" type="text/javascript"></script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-10244036-6");
pageTracker._trackPageview();
} catch(err) {}
</script>
-->
</div></div></div></div></body></html>
